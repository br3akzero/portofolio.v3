<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dApp powered by Auth.js, Web3 and NextJS 14 | Daniel Reshad</title>
    <meta name="description" content="Integrating Auth.js with Web3 Credentials Provider in Next.js 14." />
    <meta name="author" content="Daniel Reshad" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="dApp powered by Auth.js, Web3 and NextJS 14 | Daniel Reshad" />
    <meta property="og:description" content="Integrating Auth.js with Web3 Credentials Provider in Next.js 14." />
    <meta property="article:published_time" content="2024-05-15T18:18:25Z" />
    <link rel="icon" type="image/svg+xml" href="/favicon.ico" />
    <link rel="canonical" href="https://danielreshad.com/blog/web3-nextjs" />
    <meta name="theme-color" content="#000000" />
    <link rel="stylesheet" href="/style/blog.css" />
  </head>
  <body>
    <svg xmlns="http://www.w3.org/2000/svg" width="0" height="0" style="position:absolute; overflow:hidden">
      <defs>
        <filter id="glass-distortion" x="-10%" y="-10%" width="120%" height="120%">
          <feTurbulence type="fractalNoise" baseFrequency="0.015 0.015" numOctaves="2" seed="15" result="noise" />
          <feGaussianBlur in="noise" stdDeviation="1" result="blurred" />
          <feDisplacementMap in="SourceGraphic" in2="blurred" scale="4" xChannelSelector="R" yChannelSelector="G" />
        </filter>
      </defs>
    </svg>
    <div id="app">
      <header class="blog-header">
        <a href="/blog" class="back-link">&larr; Back to Blog</a>
        <div class="blog-meta">
          <time datetime="2024-05-15">May 15, 2024</time>
          <div class="blog-tags">
            <span class="blog-tag">nextjs</span>
            <span class="blog-tag">web3</span>
            <span class="blog-tag">next-auth</span>
            <span class="blog-tag">auth</span>
          </div>
        </div>
        <h1>dApp powered by Auth.js, Web3 and NextJS 14</h1>
      </header>

      <article class="blog-content">
        <p>In this tutorial, we will integrate NextAuth (now rebranded as Auth.js) with a Web3 credentials provider in a Next.js 14 application. We'll use <code>WalletConnect</code> & <code>Wagmi</code> to create a robust authentication flow.</p>

        <h2>Prerequisites</h2>

        <ul>
          <li>Basic knowledge of NextJS and React</li>
          <li>Node.js and npm installed</li>
          <li>Familiarity with Web3 concepts</li>
        </ul>

        <h2>Getting Started</h2>

        <p>Create a new Next.js 14 project and install the necessary dependencies:</p>

<pre><code>npx create-next-app@latest my-web3-app
cd my-web3-app
npm install next-auth@latest</code></pre>

        <h2>Web3 Integration with WAGMI</h2>

        <p>WAGMI is a collection of React hooks and utilities designed to help developers build Web3 applications with ease.</p>

<pre><code>npm install wagmi viem@2.x @tanstack/react-query</code></pre>

        <p>Create a WAGMI provider in <code>src/web3/wagmi/provider.tsx</code>:</p>

<pre><code>"use client";

import type { PropsWithChildren } from "react";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { type Config, type State, WagmiProvider } from "wagmi";

const client = new QueryClient();

type Props = PropsWithChildren&lt;{
  config: Config,
  initialState?: State,
}&gt;;

const Provider = ({ children, config, initialState }: Props) =&gt; {
  return (
    &lt;WagmiProvider config={config} initialState={initialState}&gt;
      &lt;QueryClientProvider client={client}&gt;{children}&lt;/QueryClientProvider&gt;
    &lt;/WagmiProvider&gt;
  );
};

export default Provider;</code></pre>

        <h2>Web3Modal + WAGMI</h2>

        <p>Install the web3modal integration:</p>

<pre><code>npm install @web3modal/wagmi</code></pre>

        <p>Create the config in <code>src/web3/web3modal/config.ts</code>:</p>

<pre><code>"use client";

import { defaultWagmiConfig } from "@web3modal/wagmi/react/config";
import { cookieStorage, createStorage } from "wagmi";
import { mainnet, sepolia } from "wagmi/chains";

export const projectId = process.env.NEXT_PUBLIC_WALLET_CONNECT_ID;

const chains = [mainnet, sepolia] as const;

const metadata = {
  name: "My dApp",
  description: "Used to connect your wallet to use dApp",
  url: "http://localhost:3000",
  icons: [],
};

export const config = defaultWagmiConfig({
  chains,
  projectId,
  metadata,
  ssr: true,
  storage: createStorage({
    storage: cookieStorage,
  }),
});</code></pre>

        <p>Once configured, you can test the wallet connection:</p>

        <div class="image-container">
          <img src="/assets/blog5.wallet.gif" alt="Web3Modal wallet connection demo" />
        </div>

        <h2>AuthJS Setup</h2>

        <p>Create <code>app/server/auth.ts</code>:</p>

<pre><code>import Credentials from "next-auth/providers/credentials";
import { getServerSession } from "next-auth";
import { isAddress } from "ethers/address";
import type { DefaultSession, NextAuthOptions } from "next-auth"

declare module "next-auth" {
  interface Session extends DefaultSession {
    address?: string;
  }
}

export const authOptions: NextAuthOptions = {
  callbacks: {
    session: ({ session, token }) =&gt; {
      session.address = token.sub;
      return session;
    },
  },
  providers: [
    Credentials({
      name: "Credentials",
      credentials: {
        address: {
          label: "Address",
          type: "text",
          placeholder: "0x0",
        },
      },
      async authorize(credentials) {
        if (!credentials?.address) return null;
        if (!isAddress(credentials?.address)) return null;
        return { id: credentials?.address };
      },
    }),
  ],
  session: { strategy: "jwt" },
  pages: {
    signIn: "/",
    signOut: "/",
    error: "/",
    newUser: "/",
  },
};

export const getServerAuthSession = () =&gt; getServerSession(authOptions);</code></pre>

        <p>Here's a diagram showing the authentication flow:</p>

        <div class="image-container">
          <img src="/assets/blog5.flow.svg" alt="Auth.js and Web3 authentication flow diagram" />
        </div>

        <h2>The useWeb3Auth Hook</h2>

        <p>Create <code>app/web3/hooks/use-web3-auth.ts</code>:</p>

<pre><code>"use client";

import { useAccount } from "wagmi";
import { useWeb3Modal, useWeb3ModalEvents } from "@web3modal/wagmi/react";
import { signIn, useSession, signOut } from "next-auth/react";
import { useEffect, useCallback, useState } from "react";

type Return = [
  isConnected: boolean,
  connect: () =&gt; Promise&lt;void&gt;,
  disconnect: () =&gt; Promise&lt;void&gt;,
];

export const useWeb3Auth = (): Return =&gt; {
  const event = useWeb3ModalEvents();
  const { status } = useSession();
  const { open } = useWeb3Modal();
  const { isConnected, address } = useAccount();
  const callbackUrl = "/swap";
  const [isOk, setOk] = useState(false);

  useEffect(() =&gt; {
    if (status === "loading") return;
    setOk(status === "authenticated");
  }, [status]);

  useEffect(() =&gt; {
    const handleConnectSuccess = async () =&gt; {
      if (event?.data?.event === "CONNECT_SUCCESS") {
        await signIn("credentials", { address, callbackUrl });
      }
    };
    if (event && address) {
      handleConnectSuccess().catch(console.error);
    }
  }, [event, address]);

  const authenticate = useCallback(async () =&gt; {
    if (!isConnected) await open();
    if (!isOk && isConnected) {
      await signIn("credentials", { address, callbackUrl });
    }
  }, [isOk, isConnected, address, open]);

  const disconnect = async () =&gt; {
    await signOut({ callbackUrl: "/" });
  };

  return [isOk, authenticate, disconnect];
};</code></pre>

        <h2>Web3Button Component</h2>

        <p>Create <code>app/components/web3-button.tsx</code>:</p>

<pre><code>"use client";

import { useWeb3Auth } from "~/web3/hooks/use-web3-auth";

export const Web3Button = () =&gt; {
  const [isAuthenticated, connect, disconnect] = useWeb3Auth();

  if (!isAuthenticated) {
    return (
      &lt;button onClick={connect}&gt;
        Connect Wallet
      &lt;/button&gt;
    );
  } else {
    return (
      &lt;button onClick={disconnect}&gt;
        Disconnect Wallet
      &lt;/button&gt;
    );
  }
};</code></pre>

        <h2>Results</h2>

        <p>Here's the complete app in action:</p>

        <div class="image-container">
          <img src="/assets/blog5.result.gif" alt="Complete dApp connecting to MetaMask wallet" />
        </div>

        <h2>Conclusion</h2>

        <p>In this blog we saw how to setup NextJS, Auth.js and Web3 to connect to a wallet as an authentication provider. Compared to traditional providers such as OAuth or Email, Web3 provides a simple and easy to use way to connect to dApps and provide both authorization and authentication.</p>

        <p>As always I was your host Break Zero and if you liked this article make sure to share as it would mean the world to me!</p>

        <p>Thank you for reading!</p>
      </article>

      <footer class="blog-footer">
        <a href="/blog" class="back-link">&larr; Back to Blog</a>
      </footer>
    </div>
  </body>
</html>
